<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Funis - An√°lise Completa</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
            min-height: 100vh;
            color: white;
            padding: 20px;
        }
        .container { max-width: 1600px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 30px; }
        .header h1 {
            font-size: 3rem;
            background: linear-gradient(45deg, #3b82f6, #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }
        .month-selector {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .month-btn {
            padding: 12px 25px;
            border: 2px solid #475569;
            border-radius: 8px;
            background: #1e293b;
            color: #e2e8f0;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        .month-btn:hover { border-color: #3b82f6; transform: translateY(-2px); }
        .month-btn.active { background: #3b82f6; border-color: #3b82f6; color: white; }
        .product-selector {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        .product-btn {
            padding: 15px 30px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            background: #334155;
            color: #e2e8f0;
        }
        .product-btn:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(0,0,0,0.3); }
        .product-btn.active {
            background: linear-gradient(45deg, #3b82f6, #8b5cf6);
            color: white;
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(59, 130, 246, 0.4);
        }
        .dashboard-content {
            display: grid;
            grid-template-columns: 250px 1fr 280px;
            gap: 20px;
            margin-bottom: 30px;
        }
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .metric-btn {
            padding: 15px 18px;
            border: none;
            border-radius: 10px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            background: #1e293b;
            color: #e2e8f0;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .metric-btn:hover { background: #334155; transform: translateX(5px); }
        .metric-btn.active { background: #3b82f6; color: white; transform: translateX(5px); }
        .main-chart {
            background: #1e293b;
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
            min-height: 520px;
            display: flex;
            flex-direction: column;
        }
        .chart-title {
            font-size: 1.6rem;
            margin-bottom: 20px;
            color: #e2e8f0;
            text-align: center;
        }
        .chart-container { position: relative; flex: 1; }

        /* FUNIL GIGANTE E VISUAL */
        .funnel-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 20px 40px;
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            flex: 1;
            justify-content: center;
        }
        .funnel-stage {
            width: 90%;
            max-width: 700px;
            text-align: center;
            padding: 16px 20px;
            border-radius: 16px;
            position: relative;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(0,0,0,0.4);
            cursor: pointer;
            height: 60px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .funnel-stage:hover {
            transform: scale(1.04) translateY(-2px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.5);
            z-index: 10;
        }
        .funnel-stage-1 { width: 100%; background: linear-gradient(135deg, #059669, #10b981); }
        .funnel-stage-2 { width: 85%; background: linear-gradient(135deg, #0891b2, #06b6d4); }
        .funnel-stage-3 { width: 70%; background: linear-gradient(135deg, #2563eb, #3b82f6); }
        .funnel-stage-4 { width: 55%; background: linear-gradient(135deg, #7c3aed, #8b5cf6); }
        .funnel-stage-5 { width: 40%; background: linear-gradient(135deg, #c026d3, #d946ef); }

        .funnel-label {
            font-size: 1rem;
            opacity: 0.95;
            font-weight: 600;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .funnel-value {
            font-size: 2.2rem;
            font-weight: bold;
            line-height: 1;
        }
        .funnel-percent {
            font-size: 0.95rem;
            opacity: 0.9;
            font-weight: 500;
            margin-top: 2px;
        }
        .funnel-arrow {
            font-size: 2rem;
            color: #94a3b8;
            opacity: 0.8;
            margin: 4px 0;
        }

        .stats-panel { display: flex; flex-direction: column; gap: 15px; }
        .stat-card {
            background: #1e293b;
            padding: 20px;
            border-radius: 12px;
            border-left: 4px solid #3b82f6;
        }
        .stat-label { color: #94a3b8; font-size: 0.9rem; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 0.5px; }
        .stat-value { font-size: 1.8rem; font-weight: bold; color: #e2e8f0; }
        .stat-value.positive { color: #10b981; }
        .stat-value.negative { color: #ef4444; }

        .taxa-ascensao-card {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            padding: 25px;
            border-radius: 12px;
            border: 3px solid #8b5cf6;
            text-align: center;
            box-shadow: 0 10px 30px rgba(139, 92, 246, 0.3);
        }
        .taxa-ascensao-card .stat-label { font-size: 1rem; color: #a78bfa; margin-bottom: 10px; }
        .taxa-ascensao-card .stat-value { font-size: 2.8rem; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .taxa-ascensao-arrow { font-size: 2rem; }

        .tendencias {
            background: #1e293b;
            padding: 20px;
            border-radius: 12px;
            border-left: 4px solid #8b5cf6;
        }
        .tendencias h3 { font-size: 1rem; margin-bottom: 15px; color: #a78bfa; }
        .tendencia-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #334155; }
        .tendencia-item:last-child { border-bottom: none; }
        .tendencia-label { color: #94a3b8; font-size: 0.9rem; }
        .tendencia-value { color: #e2e8f0; font-weight: 600; font-size: 0.9rem; }

        .bottom-cards {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }
        .bottom-card {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            border: 2px solid #475569;
            transition: all 0.3s;
        }
        .bottom-card:hover { border-color: #3b82f6; transform: translateY(-5px); box-shadow: 0 10px 30px rgba(59, 130, 246, 0.3); }
        .bottom-card-icon { font-size: 2.5rem; margin-bottom: 15px; }
        .bottom-card-label { color: #94a3b8; font-size: 0.9rem; margin-bottom: 10px; text-transform: uppercase; }
        .bottom-card-value { font-size: 1.8rem; font-weight: bold; color: #e2e8f0; }

        .ranking-section {
            background: #1e293b;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
        }
        .ranking-title { font-size: 1.8rem; margin-bottom: 25px; text-align: center; color: #e2e8f0; }
        .ranking-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
        .ranking-card {
            background: linear-gradient(135deg, #334155 0%, #1e293b 100%);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            border: 2px solid #475569;
            transition: all 0.3s;
        }
        .ranking-card:hover { border-color: #3b82f6; transform: translateY(-5px); box-shadow: 0 10px 30px rgba(59, 130, 246, 0.3); }
        .ranking-icon { font-size: 2rem; margin-bottom: 10px; }
        .ranking-label { color: #94a3b8; font-size: 0.9rem; margin-bottom: 10px; }
        .ranking-product { font-size: 1.3rem; font-weight: bold; color: #e2e8f0; margin-bottom: 5px; }
        .ranking-value { font-size: 1.1rem; font-weight: 600; color: #3b82f6; }

        @media (max-width: 1200px) {
            .dashboard-content { grid-template-columns: 1fr; }
            .funnel-container { padding: 20px; }
            .funnel-stage { width: 95% !important; height: 55px; }
            .funnel-value { font-size: 1.8rem; }
            .bottom-cards { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä DASHBOARD FUNIS</h1>
            <p>An√°lise Completa de Performance por Produto</p>
        </div>
        <div class="month-selector" id="monthSelector"></div>
        <div class="product-selector" id="productSelector"></div>
        <div class="dashboard-content">
            <div class="sidebar" id="sidebar"></div>
            <div class="main-chart">
                <h2 class="chart-title" id="chartTitle">Carregando dados...</h2>
                <div id="chartArea" style="flex: 1; display: flex; align-items: center; justify-content: center;"></div>
            </div>
            <div class="stats-panel" id="statsPanel"></div>
        </div>
        <div class="bottom-cards" id="bottomCards"></div>
        <div class="ranking-section">
            <h2 class="ranking-title">üèÜ RANKING DE PRODUTOS - COMPARA√á√ÉO</h2>
            <div class="ranking-grid" id="rankingGrid"></div>
        </div>
    </div>

    <script>
        const SHEET_ID = '1V0-yWzGbDWUEQ21CPtNcHrzPQfLTXKHNBYUlSfzO2Pc';
        const MONTHS = [
            { id: 'out', name: 'Outubro', gid: '0' },
            { id: 'nov', name: 'Novembro', gid: '799831430' },
            { id: 'dez', name: 'Dezembro', gid: '1796217875' },
            { id: 'jan', name: 'Janeiro', gid: '1107738440' },
            { id: 'fev', name: 'Fevereiro', gid: '668056747' }
        ];
        const products = [
            { id: '50 Scripts', name: '50 Scripts', icon: 'üìù' },
            { id: 'Teste', name: 'Teste', icon: 'üß™' },
            { id: 'IA Julia', name: 'IA Julia', icon: 'ü§ñ' },
            { id: 'MPM', name: 'MPM', icon: 'üìä' },
            { id: 'Couply', name: 'Couply', icon: 'üíë' }
        ];
        const metrics = [
            { id: 'geral', name: 'Vis√£o Geral', icon: 'üìä' },
            { id: 'investido', name: 'Investido', icon: 'üí∞' },
            { id: 'faturado', name: 'Faturado', icon: 'üíµ' },
            { id: 'margem', name: 'Margem', icon: 'üìà' },
            { id: 'alunos', name: 'Alunos', icon: 'üë•' },
            { id: 'qualificados', name: 'Qualificados', icon: '‚úÖ' },
            { id: 'agendados', name: 'Agendados', icon: 'üìÖ' },
            { id: 'callrealizada', name: 'Call Realizada', icon: 'üìû' },
            { id: 'vendas', name: 'N√∫mero de Vendas', icon: 'üíº' }
        ];
        let currentMonth = 'nov';
        let currentProduct = 'Teste';
        let currentMetric = 'geral';
        let chartInstance = null;
        let allData = {};

        async function loadData() {
            const month = MONTHS.find(m => m.id === currentMonth);
            if (!month) return;
            const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${month.gid}`;
            try {
                const response = await fetch(url);
                const csvText = await response.text();
                Papa.parse(csvText, {
                    complete: function(results) {
                        parseSheetData(results.data);
                        renderUI();
                    }
                });
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
            }
        }

        function parseSheetData(data) {
            const productRanges = {
                '50 Scripts': { start: 1, end: 4, tendencia: 5 },
                'Teste': { start: 8, end: 11, tendencia: 12 },
                'IA Julia': { start: 15, end: 18, tendencia: 19 },
                'MPM': { start: 22, end: 25, tendencia: 26 },
                'Couply': { start: 29, end: 32, tendencia: 33 }
            };
            allData = {};
            for (const [productName, range] of Object.entries(productRanges)) {
                const semanas = [];
                for (let i = range.start; i <= range.end; i++) {
                    const row = data[i];
                    if (!row) continue;
                    semanas.push(parseRow(row));
                }
                const tendenciaRow = data[range.tendencia];
                const tendencia = tendenciaRow ? parseRow(tendenciaRow) : null;
                allData[productName] = { semanas, tendencia };
            }
        }

        function parseRow(row) {
            const parseValue = (val) => {
                if (!val || val === '#N/A' || val === '#DIV/0!') return 0;
                let cleanVal = val.toString().replace(/[^\d,.-]/g, '');
                cleanVal = cleanVal.replace(/\./g, '');
                cleanVal = cleanVal.replace(',', '.');
                return parseFloat(cleanVal) || 0;
            };
            return {
                investido: parseValue(row[1]),
                faturado: parseValue(row[2]),
                roas: parseValue(row[3]),
                alunos: parseValue(row[4]),
                qualificados: parseValue(row[5]),
                agendados: parseValue(row[6]),
                taxaAgendamento: parseValue(row[7]),
                callRealizada: parseValue(row[8]),
                taxaComparecimento: parseValue(row[9]),
                numeroVenda: parseValue(row[10]),
                taxaConversao: parseValue(row[11]),
                faturamentoFunil: parseValue(row[15]),
                lucroFunil: parseValue(row[16])
            };
        }

        function renderUI() {
            renderMonthButtons();
            renderProductButtons();
            renderMetricButtons();
            renderStatsPanel();
            renderBottomCards();
            updateChart();
            renderRanking();
        }

        function renderMonthButtons() {
            const container = document.getElementById('monthSelector');
            container.innerHTML = MONTHS.map(month => `
                <button class="month-btn ${month.id === currentMonth ? 'active' : ''}"
                        onclick="selectMonth('${month.id}')">
                    ${month.name}
                </button>
            `).join('');
        }

        function renderProductButtons() {
            const container = document.getElementById('productSelector');
            container.innerHTML = products.map(product => `
                <button class="product-btn ${product.id === currentProduct ? 'active' : ''}"
                        onclick="selectProduct('${product.id}')">
                    ${product.icon} ${product.name}
                </button>
            `).join('');
        }

        function renderMetricButtons() {
            const container = document.getElementById('sidebar');
            container.innerHTML = metrics.map(metric => `
                <button class="metric-btn ${metric.id === currentMetric ? 'active' : ''}"
                        onclick="selectMetric('${metric.id}')">
                    <span>${metric.icon}</span>
                    <span>${metric.name}</span>
                </button>
            `).join('');
        }

        function renderStatsPanel() {
            const data = allData[currentProduct];
            if (!data) return;
            const { semanas, tendencia } = data;
            const totalInvestido = semanas.reduce((sum, s) => sum + s.investido, 0);
            const totalFaturado = semanas.reduce((sum, s) => sum + s.faturado, 0);
            const totalFaturamentoFunil = semanas.reduce((sum, s) => sum + s.faturamentoFunil, 0);
            const totalLucroFunil = semanas.reduce((sum, s) => sum + s.lucroFunil, 0);
            const taxaAscensao = calcularTaxaAscensao(semanas);
            const container = document.getElementById('statsPanel');
            container.innerHTML = `
                <div class="stat-card">
                    <div class="stat-label">üí∞ Faturamento Total</div>
                    <div class="stat-value">R$ ${totalFaturado.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">üíµ Faturamento do Funil</div>
                    <div class="stat-value">R$ ${totalFaturamentoFunil.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">üí∏ Investido Total</div>
                    <div class="stat-value">R$ ${totalInvestido.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">üìä Lucro do Funil (ROAS)</div>
                    <div class="stat-value ${totalLucroFunil >= 0 ? 'positive' : 'negative'}">
                        R$ ${totalLucroFunil.toLocaleString('pt-BR', {minimumFractionDigits: 2})}
                    </div>
                </div>
                <div class="taxa-ascensao-card">
                    <div class="stat-label">üìà TAXA DE ASCENS√ÉO</div>
                    <div class="stat-value ${taxaAscensao >= 0 ? 'positive' : 'negative'}">
                        <span class="taxa-ascensao-arrow">${taxaAscensao >= 0 ? '‚¨ÜÔ∏è' : '‚¨áÔ∏è'}</span>
                        <span>${taxaAscensao >= 0 ? '+' : ''}${taxaAscensao.toFixed(2)}%</span>
                    </div>
                </div>
                ${tendencia ? `
                <div class="tendencias">
                    <h3>üìà TEND√äNCIAS</h3>
                    <div class="tendencia-item">
                        <span class="tendencia-label">Investido</span>
                        <span class="tendencia-value">R$ ${tendencia.investido.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</span>
                    </div>
                    <div class="tendencia-item">
                        <span class="tendencia-label">Faturado</span>
                        <span class="tendencia-value">R$ ${tendencia.faturado.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</span>
                    </div>
                    <div class="tendencia-item">
                        <span class="tendencia-label">Faturamento Funil</span>
                        <span class="tendencia-value">R$ ${tendencia.faturamentoFunil.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</span>
                    </div>
                    <div class="tendencia-item">
                        <span class="tendencia-label">Alunos</span>
                        <span class="tendencia-value">${tendencia.alunos}</span>
                    </div>
                </div>
                ` : ''}
            `;
        }

        function calcularTaxaAscensao(semanas) {
            if (semanas.length < 2) return 0;
            const primeiraMetade = semanas.slice(0, Math.ceil(semanas.length / 2));
            const segundaMetade = semanas.slice(Math.ceil(semanas.length / 2));
            const mediaInicial = primeiraMetade.reduce((sum, s) => sum + s.faturado, 0) / primeiraMetade.length;
            const mediaFinal = segundaMetade.reduce((sum, s) => sum + s.faturado, 0) / segundaMetade.length;
            if (mediaInicial === 0) return 0;
            return ((mediaFinal - mediaInicial) / mediaInicial) * 100;
        }

        function renderBottomCards() {
            const data = allData[currentProduct];
            if (!data) return;
            const { semanas } = data;
            const totalInvestido = semanas.reduce((sum, s) => sum + s.investido, 0);
            const totalFaturado = semanas.reduce((sum, s) => sum + s.faturado, 0);
            const margemTotal = totalFaturado - totalInvestido;
            const roasMedio = totalInvestido > 0 ? totalFaturado / totalInvestido : 0;
            const container = document.getElementById('bottomCards');
            container.innerHTML = `
                <div class="bottom-card">
                    <div class="bottom-card-icon">üìä</div>
                    <div class="bottom-card-label">Margem Total</div>
                    <div class="bottom-card-value" style="color: ${margemTotal >= 0 ? '#10b981' : '#ef4444'}">
                        R$ ${margemTotal.toLocaleString('pt-BR', {minimumFractionDigits: 2})}
                    </div>
                </div>
                <div class="bottom-card">
                    <div class="bottom-card-icon">üéØ</div>
                    <div class="bottom-card-label">ROAS M√©dio</div>
                    <div class="bottom-card-value">${roasMedio.toFixed(2)}x</div>
                </div>
                <div class="bottom-card">
                    <div class="bottom-card-icon">üí∞</div>
                    <div class="bottom-card-label">Total Investido</div>
                    <div class="bottom-card-value">R$ ${totalInvestido.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</div>
                </div>
                <div class="bottom-card">
                    <div class="bottom-card-icon">üíµ</div>
                    <div class="bottom-card-label">Total Faturado</div>
                    <div class="bottom-card-value">R$ ${totalFaturado.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</div>
                </div>
            `;
        }

        function renderFunnel(semanas) {
            const totalAlunos = semanas.reduce((sum, s) => sum + s.alunos, 0);
            const totalQualificados = semanas.reduce((sum, s) => sum + s.qualificados, 0);
            const totalAgendados = semanas.reduce((sum, s) => sum + s.agendados, 0);
            const totalCallRealizada = semanas.reduce((sum, s) => sum + s.callRealizada, 0);
            const totalVendas = semanas.reduce((sum, s) => sum + s.numeroVenda, 0);

            const chartArea = document.getElementById('chartArea');
            const chartTitle = document.getElementById('chartTitle');
            chartTitle.textContent = 'Funil de Convers√£o - ' + currentProduct;

            chartArea.innerHTML = `
                <div class="funnel-container">
                    <div class="funnel-stage funnel-stage-1">
                        <div class="funnel-label">üë• Alunos</div>
                        <div class="funnel-value">${totalAlunos}</div>
                        <div class="funnel-percent">100%</div>
                    </div>
                    <div class="funnel-arrow">‚Üì</div>
                    <div class="funnel-stage funnel-stage-2">
                        <div class="funnel-label">‚úÖ Qualificados</div>
                        <div class="funnel-value">${totalQualificados}</div>
                        <div class="funnel-percent">${totalAlunos > 0 ? ((totalQualificados / totalAlunos) * 100).toFixed(1) : 0}%</div>
                    </div>
                    <div class="funnel-arrow">‚Üì</div>
                    <div class="funnel-stage funnel-stage-3">
                        <div class="funnel-label">üìÖ Call Agendadas</div>
                        <div class="funnel-value">${totalAgendados}</div>
                        <div class="funnel-percent">${totalQualificados > 0 ? ((totalAgendados / totalQualificados) * 100).toFixed(1) : 0}%</div>
                    </div>
                    <div class="funnel-arrow">‚Üì</div>
                    <div class="funnel-stage funnel-stage-4">
                        <div class="funnel-label">üìû Call Realizadas</div>
                        <div class="funnel-value">${totalCallRealizada}</div>
                        <div class="funnel-percent">${totalAgendados > 0 ? ((totalCallRealizada / totalAgendados) * 100).toFixed(1) : 0}%</div>
                    </div>
                    <div class="funnel-arrow">‚Üì</div>
                    <div class="funnel-stage funnel-stage-5">
                        <div class="funnel-label">üíº Vendas</div>
                        <div class="funnel-value">${totalVendas}</div>
                        <div class="funnel-percent">${totalCallRealizada > 0 ? ((totalVendas / totalCallRealizada) * 100).toFixed(1) : 0}%</div>
                    </div>
                </div>
            `;
        }

        function updateChart() {
            const data = allData[currentProduct];
            if (!data) return;
            const { semanas } = data;
            const labels = semanas.map((_, i) => `Semana ${i + 1}`);
            const chartArea = document.getElementById('chartArea');

            if (currentMetric === 'geral') {
                renderFunnel(semanas);
                return;
            }

            chartArea.innerHTML = '<div class="chart-container"><canvas id="mainChart"></canvas></div>';
            const ctx = document.getElementById('mainChart').getContext('2d');
            if (chartInstance) chartInstance.destroy();

            let datasets = [];
            let title = '';

            switch(currentMetric) {
                case 'investido':
                    datasets = [{ label: 'Investido', data: semanas.map(s => s.investido), borderColor: '#ef4444', backgroundColor: 'rgba(239,68,68,0.1)', tension: 0.4, fill: true }];
                    title = 'Investimento por Semana';
                    break;
                case 'faturado':
                    datasets = [{ label: 'Faturado', data: semanas.map(s => s.faturado), borderColor: '#10b981', backgroundColor: 'rgba(16,185,129,0.1)', tension: 0.4, fill: true }];
                    title = 'Faturamento por Semana';
                    break;
                case 'margem':
                    datasets = [
                        { label: 'Investido', data: semanas.map(s => s.investido), borderColor: '#ef4444', backgroundColor: 'rgba(239,68,68,0.1)', tension: 0.4 },
                        { label: 'Faturado', data: semanas.map(s => s.faturado), borderColor: '#10b981', backgroundColor: 'rgba(16,185,129,0.1)', tension: 0.4 },
                        { label: 'Margem', data: semanas.map(s => s.faturado - s.investido), borderColor: '#3b82f6', backgroundColor: 'rgba(59,130,246,0.1)', tension: 0.4, fill: true }
                    ];
                    title = 'Vis√£o Geral: Investido vs Faturado vs Margem';
                    break;
                case 'alunos':
                    datasets = [{ label: 'Alunos', data: semanas.map(s => s.alunos), borderColor: '#8b5cf6', backgroundColor: 'rgba(139,92,246,0.1)', tension: 0.4, fill: true }];
                    title = 'N√∫mero de Alunos por Semana';
                    break;
                case 'qualificados':
                    datasets = [{ label: 'Qualificados', data: semanas.map(s => s.qualificados), borderColor: '#06b6d4', backgroundColor: 'rgba(6,182,212,0.1)', tension: 0.4, fill: true }];
                    title = 'Alunos Qualificados por Semana';
                    break;
                case 'agendados':
                    datasets = [{ label: 'Agendados', data: semanas.map(s => s.agendados), borderColor: '#f59e0b', backgroundColor: 'rgba(245,158,11,0.1)', tension: 0.4, fill: true }];
                    title = 'Calls Agendadas por Semana';
                    break;
                case 'callrealizada':
                    datasets = [{ label: 'Call Realizada', data: semanas.map(s => s.callRealizada), borderColor: '#ec4899', backgroundColor: 'rgba(236,72,153,0.1)', tension: 0.4, fill: true }];
                    title = 'Calls Realizadas por Semana';
                    break;
                case 'vendas':
                    datasets = [{ label: 'N√∫mero de Vendas', data: semanas.map(s => s.numeroVenda), borderColor: '#10b981', backgroundColor: 'rgba(16,185,129,0.1)', tension: 0.4, fill: true }];
                    title = 'N√∫mero de Vendas por Semana';
                    break;
            }

            document.getElementById('chartTitle').textContent = title;
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: { labels, datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { labels: { color: '#e2e8f0', font: { size: 12 } } },
                        tooltip: { backgroundColor: 'rgba(15,23,42,0.9)', titleColor: '#e2e8f0', bodyColor: '#e2e8f0', borderColor: '#475569', borderWidth: 1 }
                    },
                    scales: {
                        y: { beginAtZero: true, ticks: { color: '#94a3b8' }, grid: { color: 'rgba(148,163,184,0.1)' } },
                        x: { ticks: { color: '#94a3b8' }, grid: { color: 'rgba(148,163,184,0.1)' } }
                    }
                }
            });
        }

        function renderRanking() {
            const container = document.getElementById('rankingGrid');
            const produtosRanking = products.map(product => {
                const data = allData[product.id];
                if (!data) return null;
                const { semanas } = data;
                const totalInvestido = semanas.reduce((sum, s) => sum + s.investido, 0);
                const totalFaturado = semanas.reduce((sum, s) => sum + s.faturado, 0);
                const totalFaturamentoFunil = semanas.reduce((sum, s) => sum + s.faturamentoFunil, 0);
                const totalLucroFunil = semanas.reduce((sum, s) => sum + s.lucroFunil, 0);
                const totalVendas = semanas.reduce((sum, s) => sum + s.numeroVenda, 0);
                const roasMedio = totalInvestido > 0 ? totalFaturado / totalInvestido : 0;
                const taxaAscensao = calcularTaxaAscensao(semanas);
                return { ...product, totalInvestido, totalFaturado, totalFaturamentoFunil, totalLucroFunil, totalVendas, roasMedio, taxaAscensao };
            }).filter(p => p !== null);

            const rankings = [
                { title: 'üí∞ Maior Faturamento', icon: 'üëë', key: 'totalFaturado', format: (val) => `R$ ${val.toLocaleString('pt-BR', {minimumFractionDigits: 2})}` },
                { title: 'üíµ Maior Faturamento do Funil', icon: 'üèÜ', key: 'totalFaturamentoFunil', format: (val) => `R$ ${val.toLocaleString('pt-BR', {minimumFractionDigits: 2})}` },
                { title: 'üìä Maior Lucro do Funil', icon: 'üíé', key: 'totalLucroFunil', format: (val) => `R$ ${val.toLocaleString('pt-BR', {minimumFractionDigits: 2})}` },
                { title: 'üéØ Melhor ROAS', icon: 'üåü', key: 'roasMedio', format: (val) => `${val.toFixed(2)}x` },
                { title: 'üíº Mais Vendas', icon: 'üöÄ', key: 'totalVendas', format: (val) => `${val} vendas` },
                { title: 'üìà Maior Taxa de Ascens√£o', icon: '‚¨ÜÔ∏è', key: 'taxaAscensao', format: (val) => `${val >= 0 ? '+' : ''}${val.toFixed(2)}%` }
            ];

            container.innerHTML = rankings.map(ranking => {
                const sorted = [...produtosRanking].sort((a, b) => b[ranking.key] - a[ranking.key]);
                const winner = sorted[0];
                return `
                    <div class="ranking-card">
                        <div class="ranking-icon">${ranking.icon}</div>
                        <div class="ranking-label">${ranking.title}</div>
                        <div class="ranking-product">${winner.icon} ${winner.name}</div>
                        <div class="ranking-value">${ranking.format(winner[ranking.key])}</div>
                    </div>
                `;
            }).join('');
        }

        function selectMonth(monthId) {
            currentMonth = monthId;
            loadData();
        }

        function selectProduct(productId) {
            currentProduct = productId;
            renderUI();
        }

        function selectMetric(metricId) {
            currentMetric = metricId;
            renderMetricButtons();
            updateChart();
        }

        // INICIA O DASH
        loadData();
    </script>
</body>
</html>
